topste-sniperid="save-btn" onclick="saveTrade()" disabled<!DOCTYPE html>
<html lang="fr">
<hetopstep-sniperid="save-btn" onclick="saveTrade()"ad>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topstep Sniper Suite - V5 Finale</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK (Version Compat) -->
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020408; color: #e2e8f0; overflow-x: hidden; }
        .glass { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .gold-glow { box-shadow: 0 0 20px rgba(245, 158, 11, 0.2); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        .tab-active { background-color: #f59e0b; color: #000; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2); }
        /* Styles pour l'état du bouton */
        .btn-disabled { background-color: #1e293b; color: #475569; cursor: not-allowed; opacity: 0.5; }
        .btn-active { background-color: #10b981; color: #000; cursor: pointer; box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3); transform: scale(1.02); }
    </style>
</head>
<body class="min-h-screen pb-20">
    
    <div class="max-w-7xl mx-auto p-3 lg:p-6">
        <!-- HEADER FIXE -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 gap-6 border-b border-white/5 pb-6 sticky top-0 z-50 bg-[#020408]/95 backdrop-blur-md pt-4">
            <div class="flex items-center gap-5">
                <div class="bg-amber-500 p-3.5 rounded-3xl text-black gold-glow">
                    <i data-lucide="target" class="w-8 h-8"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black text-white uppercase italic tracking-tighter">Sniper <span class="text-amber-500">Suite</span></h1>
                    <div class="flex items-center gap-2">
                        <span id="status-dot" class="w-1.5 h-1.5 rounded-full bg-slate-700"></span>
                        <p id="status-text" class="text-[9px] text-slate-500 font-bold uppercase tracking-widest italic">Connexion...</p>
                    </div>
                </div>
            </div>
            
            <nav class="flex glass p-1.5 rounded-2xl border border-white/5">
                <button onclick="changeTab('home')" id="nav-home" class="nav-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase transition-all text-slate-500 hover:text-slate-300">Accueil</button>
                <button onclick="changeTab('desk')" id="nav-desk" class="nav-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase transition-all text-slate-500 hover:text-slate-300">Desk</button>
                <button onclick="changeTab('performance')" id="nav-performance" class="nav-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase transition-all text-slate-500 hover:text-slate-300">Journal</button>
            </nav>
        </header>

        <!-- CONTENU DYNAMIQUE -->
        <main id="main-content" class="min-h-[60vh]"></main>

        <footer class="mt-12 border-t border-slate-800 pt-6 text-center text-slate-700 text-[9px] font-black uppercase tracking-[0.4em] italic">
            Topstep Sniper Suite • Station Cloud v5.0
        </footer>
    </div>

    <script>
        // --- CONFIGURATION CORRIGÉE (topste-) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA9oTG8YCTwYrp6apiirCvefst-6kuyFtk",
            authDomain: "topstep-sniper-journalv2.firebaseapp.com",
            projectId: "topstep-sniper-journalv2",
            storageBucket: "topstep-sniper-journalv2.firebasestorage.app",
            messagingSenderId: "109480561609",
            appId: "1:109480561609:web:f6cc7b649ffc039728f618",
            measurementId: "G-T1FDXHBSGJ"
        };
        const APP_ID = "topstep-sniper-journalv2";
        
        let db, auth;
        let state = {
            activeTab: 'home',
            user: null,
            startingCapital: 50000,
            trades: [],
            isSyncing: false,
            expandedTrade: null,
            form: {
                pnl: "",
                emotions: "",
                screenshot: "",
                checklist: [
                    { id: 1, text: "M30 : ALERTE GOLD INDICATOR + US RIDER", status: false, cat: "Setup A+" },
                    { id: 2, text: "CONTEXTE : ALIGNEMENT H1 / CONTINUITÉ", status: false, cat: "Setup A+" },
                    { id: 3, text: "STRUCTURE : PRIX HORS ZONES DE BRUIT", status: false, cat: "Analyse" },
                    { id: 4, text: "M5 SNIPE : VECTEUR DORÉ / REBOND OK", status: false, cat: "Entrée" },
                    { id: 5, text: "MENTAL : CALME & DISCIPLINÉ (PAS DE FOMO)", status: false, cat: "Mental" },
                    { id: 6, text: "RISQUE : SL PLACÉ / TAILLE DE POSITION OK", status: false, cat: "Gestion" }
                ]
            }
        };

        // --- INITIALISATION ---
        function initApp() {
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();

                auth.onAuthStateChanged(user => {
                    if (user) {
                        state.user = user;
                        document.getElementById('status-dot').className = "w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse";
                        document.getElementById('status-text').innerText = "Cloud Sync Active";
                        loadUserData();
                    } else {
                        auth.signInAnonymously().catch(e => alert("Erreur Auth: " + e.message));
                    }
                });
            } catch (e) {
                console.error("Erreur Init:", e);
            }
        }

        function loadUserData() {
            if (!state.user) return;
            const userId = state.user.uid;
            
            db.collection('artifacts').doc(APP_ID).collection('users').doc(userId).collection('trades')
              .onSnapshot(snap => {
                  state.trades = snap.docs.map(d => ({id: d.id, ...d.data()}))
                      .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                  // On ne re-rend que si on est sur l'onglet performance ou home pour éviter de casser la saisie du desk
                  if (state.activeTab !== 'desk') renderContent();
              });

            db.collection('artifacts').doc(APP_ID).collection('users').doc(userId).collection('settings').doc('account')
              .onSnapshot(doc => {
                  if (doc.exists) {
                      state.startingCapital = doc.data().startingCapital;
                      if (state.activeTab === 'performance' || state.activeTab === 'home') renderContent();
                  }
              });
        }

        // --- LOGIQUE UI INTELLIGENTE ---
        function changeTab(tab) {
            state.activeTab = tab;
            renderContent();
        }

        function toggleCheck(id) {
            state.form.checklist = state.form.checklist.map(i => i.id === id ? {...i, status: !i.status} : i);
            // On met à jour l'icone visuellement sans recharger tout le HTML
            const btnIcon = document.getElementById(`check-icon-${id}`);
            const btnContainer = document.getElementById(`check-btn-${id}`);
            if (btnIcon && btnContainer) {
                const item = state.form.checklist.find(i => i.id === id);
                if (item.status) {
                    btnContainer.className = "w-full flex items-center justify-between p-5 rounded-2xl border transition-all bg-emerald-500/10 border-emerald-500/30 text-emerald-400";
                    btnIcon.setAttribute('data-lucide', 'check-circle-2');
                } else {
                    btnContainer.className = "w-full flex items-center justify-between p-5 rounded-2xl border transition-all bg-black/40 border-slate-800 text-slate-500 hover:border-slate-600";
                    btnIcon.setAttribute('data-lucide', 'circle');
                }
                lucide.createIcons();
            }
            checkValidation();
        }

        function handleInput(field, value) {
            state.form[field] = value;
            checkValidation();
        }

        function checkValidation() {
            const btn = document.getElementById('save-btn');
            if (!btn) return;

            const isChecklistComplete = state.form.checklist.every(i => i.status);
            const isPnlFilled = state.form.pnl !== "";
            const isReady = isChecklistComplete && isPnlFilled && state.user;

            if (isReady) {
                btn.disabled = false;
                btn.className = "w-full p-6 font-black rounded-[2rem] uppercase text-xs mt-4 transition-all btn-active animate-pulse-fast";
                btn.innerHTML = `<i data-lucide="save" class="inline w-4 h-4 mr-2"></i> ARCHIVER LE SNIPE`;
            } else {
                btn.disabled = true;
                btn.className = "w-full p-6 font-black rounded-[2rem] uppercase text-xs mt-4 transition-all btn-disabled";
                btn.innerHTML = `Complétez Checklist + PnL`;
            }
            lucide.createIcons();
        }

        function handleImage(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onloadend = () => { 
                state.form.screenshot = reader.result;
                // Petit hack pour montrer l'image sans recharger
                const imgContainer = document.getElementById('img-preview');
                if (imgContainer) imgContainer.innerHTML = `<img src="${reader.result}" class="w-full h-full object-cover opacity-80" />`;
            };
            reader.readAsDataURL(file);
        }

        async function updateCapital(val) {
            if (!state.user) return;
            state.startingCapital = Number(val);
            await db.collection('artifacts').doc(APP_ID).collection('users').doc(state.user.uid).collection('settings').doc('account').set({ startingCapital: state.startingCapital }, { merge: true });
        }

        async function saveTrade() {
            if (!state.user || !state.form.pnl || state.isSyncing) return;
            state.isSyncing = true;
            const btn = document.getElementById('save-btn');
            if(btn) btn.innerText = "Synchronisation Cloud...";

            try {
                await db.collection('artifacts').doc(APP_ID).collection('users').doc(state.user.uid).collection('trades').add({
                    pnl: Number(state.form.pnl),
                    emotions: state.form.emotions,
                    screenshot: state.form.screenshot,
                    score: state.form.checklist.filter(i => i.status).length,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    type: state.form.checklist[0].status ? 'BUY' : 'SELL'
                });

                // Reset
                state.form.pnl = ""; state.form.emotions = ""; state.form.screenshot = "";
                state.form.checklist.forEach(i => i.status = false);
                state.activeTab = 'performance';
                renderContent(); // Force render pour aller sur l'onglet performance
                
            } catch (e) {
                alert("Erreur : " + e.message);
                state.isSyncing = false;
                checkValidation(); // Restore button state
            } finally {
                state.isSyncing = false;
            }
        }

        async function deleteTrade(id) {
            if (!confirm("Supprimer ?")) return;
            await db.collection('artifacts').doc(APP_ID).collection('users').doc(state.user.uid).collection('trades').doc(id).delete();
            // Le listener rechargera l'UI
        }

        function toggleExpand(id) {
            state.expandedTrade = state.expandedTrade === id ? null : id;
            renderContent();
        }

        // --- RENDU PRINCIPAL ---
        function renderContent() {
            const container = document.getElementById('main-content');
            if (!container) return;

            // Update Nav Classes
            document.querySelectorAll('.nav-btn').forEach(btn => btn.className = "nav-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase transition-all text-slate-500 hover:text-slate-300");
            const activeBtn = document.getElementById(`nav-${state.activeTab}`);
            if (activeBtn) activeBtn.className = "nav-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase transition-all tab-active";

            const wins = state.trades.filter(t => Number(t.pnl) > 0);
            const pnlNet = state.trades.reduce((acc, t) => acc + Number(t.pnl), 0);
            const winRate = state.trades.length > 0 ? (wins.length / state.trades.length * 100).toFixed(1) : 0;

            let html = '';

            if (state.activeTab === 'home') {
                html = `
                    <div class="max-w-4xl mx-auto text-center py-12 animate-fadeIn">
                        <div class="inline-block bg-amber-500/10 border border-amber-500/20 px-4 py-2 rounded-full text-amber-500 text-[10px] font-black uppercase tracking-[0.3em] mb-8">Setup M30 A+</div>
                        <h2 class="text-5xl lg:text-7xl font-black text-white italic tracking-tighter mb-8 leading-tight uppercase">Précision.<br/><span class="text-amber-500">Discipline. Profits.</span></h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                            <div class="glass p-8 rounded-[2.5rem] border border-white/5"><div class="text-[10px] text-slate-500 font-bold uppercase mb-2">Balance</div><div class="text-3xl font-black italic tracking-tighter">$${(state.startingCapital + pnlNet).toLocaleString()}</div></div>
                            <div class="glass p-8 rounded-[2.5rem] border border-white/5"><div class="text-[10px] text-slate-500 font-bold uppercase mb-2">Win Rate</div><div class="text-3xl font-black italic tracking-tighter">${winRate}%</div></div>
                            <div class="glass p-8 rounded-[2.5rem] border border-white/5"><div class="text-[10px] text-slate-500 font-bold uppercase mb-2">Snipes</div><div class="text-3xl font-black italic tracking-tighter">${state.trades.length}</div></div>
                        </div>
                        <button onclick="changeTab('desk')" class="bg-amber-500 text-black px-12 py-6 rounded-[2.5rem] font-black uppercase text-xs shadow-xl active:scale-95 transition-all">Lancer une session</button>
                    </div>
                `;
            } else if (state.activeTab === 'desk') {
                // Rendu initial du desk. Les mises à jour suivantes se feront via DOM direct pour éviter le saut.
                html = `
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-7xl mx-auto animate-fadeIn">
                        <div class="glass p-8 rounded-[3rem] border border-white/5 shadow-2xl">
                            <h3 class="text-lg font-black text-white mb-8 italic uppercase border-b border-white/5 pb-4">Validation Sniper</h3>
                            <div class="space-y-3">
                                ${state.form.checklist.map(item => `
                                    <button id="check-btn-${item.id}" onclick="toggleCheck(${item.id})" class="w-full flex items-center justify-between p-5 rounded-2xl border transition-all ${item.status ? 'bg-emerald-500/10 border-emerald-500/30 text-emerald-400' : 'bg-black/40 border-slate-800 text-slate-500 hover:border-slate-600'}">
                                        <div class="text-left"><div class="text-[8px] font-black opacity-40 mb-1 uppercase">${item.cat}</div><div class="text-[11px] font-bold tracking-tight">${item.text}</div></div>
                                        <i id="check-icon-${item.id}" data-lucide="${item.status ? 'check-circle-2' : 'circle'}" class="w-5 h-5"></i>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div class="glass p-8 rounded-[3rem] border border-white/5 shadow-2xl">
                                <h3 class="text-lg font-black text-white mb-6 italic uppercase border-b border-white/5 pb-4">Bilan Trade</h3>
                                <div class="space-y-5">
                                    <div class="bg-black/40 p-1 rounded-2xl border border-slate-800 flex items-center">
                                        <span class="pl-4 text-amber-500 font-black">$</span>
                                        <input type="number" oninput="handleInput('pnl', this.value)" value="${state.form.pnl}" placeholder="P&L NET (EX: 250)" class="w-full bg-transparent p-4 text-xs font-black text-white outline-none" />
                                    </div>
                                    <textarea oninput="handleInput('emotions', this.value)" placeholder="NOTES : CALME ? PATIENT ? FOMO ?" rows="3" class="w-full bg-black/40 border border-slate-800 rounded-2xl p-5 text-xs font-bold text-white outline-none focus:border-amber-500/50 transition-all font-bold italic">${state.form.emotions}</textarea>
                                    
                                    <label class="flex flex-col items-center justify-center w-full h-36 border-2 border-slate-800 border-dashed rounded-[2.5rem] cursor-pointer bg-black/20 hover:bg-black/40 transition-all overflow-hidden relative" id="img-preview">
                                        ${state.form.screenshot ? `<img src="${state.form.screenshot}" class="w-full h-full object-cover opacity-80" />` : `<div class="flex flex-col items-center"><i data-lucide="upload" class="text-slate-600 mb-2 w-6 h-6"></i><span class="text-[10px] font-black text-slate-500 uppercase">Capture Graphique</span></div>`}
                                        <input type="file" class="hidden" accept="image/*" onchange="handleImage(this)" />
                                    </label>
                                    
                                    <button id="save-btn" onclick="saveTrade()" disabled class="w-full p-6 font-black rounded-[2rem] uppercase text-xs mt-4 transition-all btn-disabled">
                                        Complétez Checklist + PnL
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (state.activeTab === 'performance') {
                html = `
                    <div class="space-y-8 animate-fadeIn">
                        <div class="glass p-6 rounded-3xl flex items-center justify-between border border-white/5 shadow-lg">
                            <div class="flex items-center gap-4"><div class="bg-amber-500/10 p-3 rounded-2xl text-amber-500"><i data-lucide="settings"></i></div><div><h3 class="text-sm font-black text-white uppercase italic">Capital Initial</h3></div></div>
                            <input type="number" value="${state.startingCapital}" onchange="updateCapital(this.value)" class="bg-black border border-slate-800 rounded-xl p-3 text-xs font-black text-amber-500 outline-none w-32 text-center" />
                        </div>
                        <div class="glass p-8 rounded-[3rem] border border-white/5 shadow-2xl overflow-x-auto">
                            <table class="w-full text-left min-w-[700px]">
                                <thead class="text-[10px] text-slate-500 font-black uppercase tracking-widest border-b border-white/5">
                                    <tr><th class="pb-6 w-12 text-center">Voir</th><th class="pb-6">Date</th><th class="pb-6 text-center">Score</th><th class="pb-6 text-center">Img</th><th class="pb-6 text-right">PnL ($)</th><th class="pb-6 text-right pr-4">Action</th></tr>
                                </thead>
                                <tbody class="text-xs">
                                    ${state.trades.length === 0 ? '<tr><td colspan="6" class="py-20 text-center text-slate-700 font-black uppercase tracking-[0.4em]">Aucun sniping enregistré</td></tr>' : ''}
                                    ${state.trades.map(t => `
                                        <tr class="border-b border-white/5 hover:bg-white/5 transition-all">
                                            <td class="py-5 text-center"><button onclick="toggleExpand('${t.id}')" class="p-2 text-slate-500 hover:text-white"><i data-lucide="${state.expandedTrade === t.id ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4"></i></button></td>
                                            <td class="py-5 font-mono text-slate-400">${t.timestamp ? new Date(t.timestamp.seconds * 1000).toLocaleDateString() : 'Sync...'}</td>
   ;                                         <td class="py-5 text-center font-black text-amber-500 italic">${t.score}/6</td>
                                            <td class="py-5 text-center">${t.screenshot ? '<i data-lucide="image" class="w-4 h-4 mx-auto text-emerald-500"></i>' : '-'}</td>
                                            <td class="py-5 text-right font-black italic tracking-tighter ${Number(t.pnl) >= 0 ? 'text-emerald-500' : 'text-rose-500'}">$${Number(t.pnl).toLocaleString()}</td>
                                            <td class="py-5 text-right pr-2"><button onclick="deleteTrade('${t.id}')" class="p-2 text-slate-800 hover:text-rose-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                                        </tr>
                                        ${state.expandedTrade === t.id ? `<tr><td colspan="6" class="p-8 bg-black/40"><div class="grid grid-cols-1 md:grid-cols-2 gap-10"><div><h4 class="text-[10px] font-black text-amber-500 uppercase italic mb-3">Notes de session</h4><p class="text-xs text-slate-300 italic leading-relaxed whitespace-pre-wrap">${t.emotions || "Aucune note."}</p></div>${t.screenshot ? `<img src="${t.screenshot}" class="w-full h-auto rounded-2xl shadow-2xl border border-white/10" />` : ''}</div></td></tr>` : ''}
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
            // Mettre à jour l'état du bouton ARCHIVER en temps réel
if (state.activeTab === 'desk') {
const saveBtn = document.getElementById('save-btn');
if (saveBtn) {
const isReady = state.form.checklist.every(i => i.status) && state.form.pnl;
saveBtn.disabled = !isReady;
saveBtn.className = isReady ? 'w-full p-6 font-black rounded-[2rem] uppercase text-xs mt-4 transition-all bg-amber-500 text-black' : 'w-full p-6 font-black rounded-[2rem] uppercase text-xs mt-4 transition-all btn-disabled';
saveBtn.textContent = isReady ? 'Archiver le Snipe' : 'Complétez Checklist + PNL';
}
}
            lucide.createIcons();
            // Gérer l'état du bouton ARCHIVER
const saveBtn = document.getElementById('save-btn');
if (saveBtn && state.activeTab === 'desk') {
const isReady = state.form.checklist.every(i => i.status) && state.form.pnl;saveBtn.disabled = !isReady;
saveBtn.className = isReady ? 'w-full p-6 font-black rounded-[2rem] uppercase text-xs mt-4 transition-all bg-amber-500 text-black' : 'w-full p-6 font-black rounded-[2rem] uppercase text-xs mt-4 transition-all btn-disabled';
saveBtn.textContent = isReady ? 'Archiver le Snipe' : 'Complétez Checklist + PNL';
}
            // On appelle checkValidation pour mettre le bouton dans le bon état au chargement du desk
            if (state.activeTab === 'desk') checkValidation();
        }

        initApp();
        renderContent();
    </script>
</body>
</html>
