<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topstep Sniper Suite - M30 A+</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDK (Version Compat) -->
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020408; color: #e2e8f0; overflow-x: hidden; scroll-behavior: smooth; }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glass { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .gold-glow { box-shadow: 0 0 20px rgba(245, 158, 11, 0.2); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="max-w-7xl mx-auto p-3 lg:p-6">
        <!-- Écran de chargement initial -->
        <div id="loader" class="flex flex-col items-center justify-center h-[80vh] space-y-6">
            <div class="relative">
                <div class="w-16 h-16 border-4 border-amber-500/20 border-t-amber-500 rounded-full animate-spin"></div>
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="w-2 h-2 bg-amber-500 rounded-full animate-pulse"></div>
                </div>
            </div>
            <div class="text-center">
                <h2 class="text-amber-500 font-black uppercase tracking-[0.3em] mb-2">Sniper Terminal</h2>
                <p class="text-slate-500 text-[10px] uppercase font-bold tracking-widest">Initialisation Cloud...</p>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION FIREBASE (TES CLÉS INTÉGRÉES) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA9oTG8YCTwYrp6apiirCvefst-6kuyFtk",
            authDomain: "topste-sniper-journalv2.firebaseapp.com",
            projectId: "topste-sniper-journalv2",
            storageBucket: "topste-sniper-journalv2.firebasestorage.app",
            messagingSenderId: "109480561609",
            appId: "1:109480561609:web:f6cc7b649ffc039728f618",
            measurementId: "G-T1FDXHBSGJ"
        };

        const APP_ID = "topste-sniper-journalv2";
        let db, auth;

        // --- ÉTAT GLOBAL ---
        let state = {
            activeTab: 'home',
            user: null,
            startingCapital: 50000,
            tradeLogs: [],
            isSyncing: false,
            expandedTrade: null,
            tempPnl: "",
            tempEmotions: "",
            tempScreenshot: "",
            checklist: [
                { id: 1, text: "M30 : SIGNAL GOLD INDICATOR + US RIDER", status: false, category: "M30 SETUP" },
                { id: 2, text: "CONTEXTE : ALIGNEMENT H1 / CONTINUITÉ", status: false, category: "CONTEXTE" },
                { id: 3, text: "STRUCTURE : PRIX HORS ZONES DE BRUIT", status: false, category: "ANALYSE" },
                { id: 4, text: "M5 SNIPE : VECTEUR DORÉ / REBOND OK", status: false, category: "EXÉCUTION" },
                { id: 5, text: "MENTAL : CALME & DISCIPLINÉ (PAS DE FOMO)", status: false, category: "PSY" },
                { id: 6, text: "RISQUE : SL PLACÉ / TAILLE DE POSITION OK", status: false, category: "GESTION" }
            ]
        };

        // --- INITIALISATION ---
        async function start() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                
                auth.onAuthStateChanged(user => {
                    if (user) {
                        state.user = user;
                        loadData();
                    } else {
                        auth.signInAnonymously();
                    }
                });
            } catch (e) {
                console.error("Erreur d'initialisation:", e);
            }
        }

        function loadData() {
            const userId = state.user.uid;
            
            // Écouter les trades
            db.collection('artifacts').doc(APP_ID).collection('users').doc(userId).collection('trades')
              .onSnapshot(snap => {
                state.tradeLogs = snap.docs.map(d => ({id: d.id, ...d.data()}))
                    .sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                render();
              }, err => console.error(err));

            // Écouter le capital
            db.collection('artifacts').doc(APP_ID).collection('users').doc(userId).collection('settings').doc('account')
              .onSnapshot(doc => {
                if (doc.exists) { 
                    state.startingCapital = doc.data().startingCapital; 
                    render(); 
                }
              }, err => console.error(err));
        }

        // --- ACTIONS ---
        function setActiveTab(tab) { 
            state.activeTab = tab; 
            render(); 
        }
        
        function toggleCheck(id) {
            state.checklist = state.checklist.map(i => i.id === id ? {...i, status: !i.status} : i);
            render(); // Rendu immédiat mais stable
        }

        function toggleExpand(id) {
            state.expandedTrade = state.expandedTrade === id ? null : id;
            render();
        }

        async function saveTrade() {
            if (!state.tempPnl || !state.user || state.isSyncing) return;
            state.isSyncing = true; 
            render();

            try {
                await db.collection('artifacts').doc(APP_ID).collection('users').doc(state.user.uid).collection('trades').add({
                    pnl: Number(state.tempPnl),
                    emotions: state.tempEmotions,
                    screenshotData: state.tempScreenshot,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    checklistStatus: state.checklist.filter(i => i.status).length,
                    type: state.checklist[0].status ? 'BUY' : 'SELL'
                });
                
                // Reset
                state.tempPnl = ""; 
                state.tempEmotions = ""; 
                state.tempScreenshot = "";
                state.checklist.forEach(i => i.status = false);
                state.activeTab = 'performance';
            } catch (e) { 
                console.error("Erreur save:", e); 
            } finally {
                state.isSyncing = false;
                render();
            }
        }

        async function updateCapital(val) {
            state.startingCapital = Number(val);
            if (state.user) {
                await db.collection('artifacts').doc(APP_ID).collection('users').doc(state.user.uid).collection('settings').doc('account').set({ startingCapital: state.startingCapital });
            }
            render();
        }

        function handleImage(input) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 800000) { alert("Image trop lourde (max 800Ko)"); return; }
            const reader = new FileReader();
            reader.onloadend = () => { state.tempScreenshot = reader.result; render(); };
            reader.readAsDataURL(file);
        }

        async function deleteTrade(id) {
            if (!confirm("Supprimer ce trade définitivement ?")) return;
            await db.collection('artifacts').doc(APP_ID).collection('users').doc(state.user.uid).collection('trades').doc(id).delete();
        }

        // --- CALCULS STATS ---
        function calculateStats() {
            const total = state.tradeLogs.length;
            const wins = state.tradeLogs.filter(t => Number(t.pnl) > 0);
            const net = state.tradeLogs.reduce((acc, t) => acc + Number(t.pnl), 0);
            const grossProfit = wins.reduce((acc, t) => acc + Number(t.pnl), 0);
            const losses = state.tradeLogs.filter(t => Number(t.pnl) < 0);
            const grossLoss = Math.abs(losses.reduce((acc, t) => acc + Number(t.pnl), 0));
            return {
                totalTrades: total,
                winRate: total > 0 ? (wins.length / total) * 100 : 0,
                netProfit: net,
                profitFactor: grossLoss > 0 ? (grossProfit / grossLoss).toFixed(2) : (grossProfit > 0 ? "INF" : "0.00")
            };
        }

        // --- RENDU UI ---
        function render() {
            const appDiv = document.getElementById('app');
            const stats = calculateStats();
            
            // On construit le squelette une seule fois ou on vérifie le header
            appDiv.innerHTML = `
                <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6 border-b border-white/5 pb-8">
                    <div class="flex items-center gap-5">
                        <div class="bg-amber-500 p-3.5 rounded-3xl shadow-lg shadow-amber-500/20 text-black gold-glow">
                            <i data-lucide="target" class="w-8 h-8"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl font-black text-white uppercase italic tracking-tighter">Sniper <span class="text-amber-500">Suite</span></h1>
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full ${state.user ? 'bg-emerald-500 animate-pulse' : 'bg-slate-700'}"></span>
                                <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">Cloud Sync Active</p>
                            </div>
                        </div>
                    </div>
                    
                    <nav class="flex glass p-1.5 rounded-2xl border border-white/5">
                        <button onclick="setActiveTab('home')" class="flex items-center gap-2 px-6 py-3 rounded-xl text-[10px] font-black uppercase transition-all ${state.activeTab === 'home' ? 'bg-amber-500 text-black' : 'text-slate-500 hover:text-slate-300'}">
                            <i data-lucide="home" class="w-4 h-4"></i> Accueil
                        </button>
                        <button onclick="setActiveTab('desk')" class="flex items-center gap-2 px-6 py-3 rounded-xl text-[10px] font-black uppercase transition-all ${state.activeTab === 'desk' ? 'bg-amber-500 text-black' : 'text-slate-500 hover:text-slate-300'}">
                            <i data-lucide="layout-dashboard" class="w-4 h-4"></i> Desk
                        </button>
                        <button onclick="setActiveTab('performance')" class="flex items-center gap-2 px-6 py-3 rounded-xl text-[10px] font-black uppercase transition-all ${state.activeTab === 'performance' ? 'bg-amber-500 text-black' : 'text-slate-500 hover:text-slate-300'}">
                            <i data-lucide="bar-chart-3" class="w-4 h-4"></i> Journal
                        </button>
                    </nav>
                </header>

                <main class="animate-fadeIn min-h-[60vh]">
                    ${state.activeTab === 'home' ? renderHome(stats) : 
                      state.activeTab === 'desk' ? renderDesk() : 
                      renderPerformance(stats)}
                </main>

                <footer class="mt-12 border-t border-slate-800 pt-6 text-center text-slate-700 text-[9px] font-black uppercase tracking-[0.4em] italic">
                    Topstep Sniper Suite • Station Cloud v3.2
                </footer>
            `;
            lucide.createIcons();
        }

        function renderHome(stats) {
            return `
                <div class="max-w-4xl mx-auto text-center py-12">
                    <div class="inline-block bg-amber-500/10 border border-amber-500/20 px-4 py-2 rounded-full text-amber-500 text-[10px] font-black uppercase tracking-[0.3em] mb-8">
                        Système Gold M30 A+ Activé
                    </div>
                    <h2 class="text-5xl lg:text-7xl font-black text-white italic tracking-tighter mb-8 leading-tight uppercase">Précision.<br/><span class="text-amber-500">Discipline. Profits.</span></h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                        <div class="glass p-8 rounded-[2.5rem] border border-white/5 shadow-xl">
                            <div class="text-[10px] text-slate-500 font-bold uppercase mb-2 tracking-widest">Balance Actuelle</div>
                            <div class="text-3xl font-black text-white font-mono italic">$${(state.startingCapital + stats.netProfit).toLocaleString()}</div>
                        </div>
                        <div class="glass p-8 rounded-[2.5rem] border border-white/5 shadow-xl">
                            <div class="text-[10px] text-slate-500 font-bold uppercase mb-2 tracking-widest">Taux de Succès</div>
                            <div class="text-3xl font-black text-white font-mono italic">${stats.winRate.toFixed(1)}%</div>
                        </div>
                        <div class="glass p-8 rounded-[2.5rem] border border-white/5 shadow-xl">
                            <div class="text-[10px] text-slate-500 font-bold uppercase mb-2 tracking-widest">Snipes Archivés</div>
                            <div class="text-3xl font-black text-white font-mono italic">${stats.totalTrades}</div>
                        </div>
                    </div>

                    <button onclick="setActiveTab('desk')" class="bg-amber-500 hover:bg-amber-400 text-black px-12 py-6 rounded-[2.5rem] font-black uppercase text-xs flex items-center gap-4 mx-auto shadow-xl shadow-amber-500/20 active:scale-95 transition-all">
                        Ouvrir le Trading Desk <i data-lucide="arrow-right"></i>
                    </button>
                </div>
            `;
        }

        function renderDesk() {
            const isReady = state.checklist.every(i => i.status) && state.tempPnl;
            return `
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-7xl mx-auto">
                    <!-- Checklist -->
                    <div class="glass p-8 rounded-[3rem] border border-white/5 shadow-2xl">
                        <h3 class="text-lg font-black text-white mb-8 flex items-center gap-3 italic uppercase border-b border-white/5 pb-4"><i data-lucide="shield-check" class="text-amber-500"></i> Validation M30 A+</h3>
                        <div class="space-y-3">
                            ${state.checklist.map(item => `
                                <button onclick="toggleCheck(${item.id})" class="w-full flex items-center justify-between p-5 rounded-2xl border transition-all ${item.status ? 'bg-emerald-500/10 border-emerald-500/30 text-emerald-400' : 'bg-black/40 border-slate-800 text-slate-500 hover:border-slate-600'}">
                                    <div class="text-left">
                                        <div class="text-[8px] font-black opacity-40 mb-1 uppercase">${item.category}</div>
                                        <div class="text-[11px] font-bold tracking-tight">${item.text}</div>
                                    </div>
                                    <i data-lucide="${item.status ? 'check-circle-2' : 'circle'}" class="w-5 h-5"></i>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Inputs -->
                    <div class="space-y-6">
                        <div class="glass p-8 rounded-[3rem] border border-white/5 shadow-2xl">
                            <h3 class="text-lg font-black text-white mb-6 italic uppercase border-b border-white/5 pb-4">Données du Trade</h3>
                            <div class="space-y-5">
                                <div class="bg-black/40 p-1 rounded-2xl border border-slate-800 focus-within:border-amber-500/50 transition-all flex items-center">
                                    <span class="pl-4 text-amber-500 font-black">$</span>
                                    <input type="number" oninput="state.tempPnl = this.value" value="${state.tempPnl}" placeholder="P&L NET (EX: 250)" class="w-full bg-transparent p-4 text-xs font-black text-white outline-none" />
                                </div>
                                
                                <textarea oninput="state.tempEmotions = this.value" placeholder="ÉMOTIONS & NOTES : ÉTAIS-TU CALME ? AS-TU RESPECTÉ LE M30 ?" rows="3" class="w-full bg-black/40 border border-slate-800 rounded-2xl p-5 text-xs font-bold text-white outline-none focus:border-amber-500/50 transition-all resize-none font-bold">${state.tempEmotions}</textarea>
                                
                                <div class="space-y-2">
                                    <label class="flex flex-col items-center justify-center w-full h-36 border-2 border-slate-800 border-dashed rounded-[2.5rem] cursor-pointer bg-black/20 hover:bg-black/40 transition-all overflow-hidden relative">
                                        ${state.tempScreenshot ? `<img src="${state.tempScreenshot}" class="w-full h-full object-cover" />` : `
                                            <div class="flex flex-col items-center"><i data-lucide="upload" class="text-slate-600 mb-2 w-6 h-6"></i><span class="text-[10px] font-black text-slate-500 uppercase">Importer Capture</span></div>
                                        `}
                                        <input type="file" class="hidden" accept="image/*" onchange="handleImage(this)" />
                                    </label>
                                </div>

                                <button onclick="saveTrade()" class="w-full p-6 ${isReady ? 'bg-emerald-500 text-black shadow-lg shadow-emerald-500/20 animate-pulse' : 'bg-slate-800 text-slate-600 cursor-not-allowed'} font-black rounded-[2rem] uppercase text-xs flex flex-col items-center mt-4 transition-all">
                                    ${state.isSyncing ? 'Synchronisation Cloud...' : '<i data-lucide="save" class="mb-1"></i> Archiver le Snipe'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPerformance(stats) {
            return `
                <div class="space-y-8 max-w-7xl mx-auto">
                    <div class="glass p-6 rounded-3xl flex flex-col md:flex-row items-center justify-between gap-6 border border-white/5 shadow-lg">
                        <div class="flex items-center gap-4">
                            <div class="bg-amber-500/10 p-3 rounded-2xl text-amber-500"><i data-lucide="settings" class="w-5 h-5"></i></div>
                            <div>
                                <h3 class="text-sm font-black text-white uppercase italic">Configuration Compte</h3>
                                <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest italic">Capital de Départ Topstep</p>
                            </div>
                        </div>
                        <input type="number" value="${state.startingCapital}" onchange="updateCapital(this.value)" class="bg-black border border-slate-800 rounded-xl p-3 text-xs font-black text-amber-500 outline-none w-32 text-center" />
                    </div>

                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="glass p-6 rounded-[2rem] border border-white/5">
                            <span class="text-[10px] font-black text-slate-600 uppercase mb-2 block tracking-widest">Win Rate</span>
                            <div class="text-2xl font-black text-blue-500 italic tracking-tighter">${stats.winRate.toFixed(1)}%</div>
                        </div>
                        <div class="glass p-6 rounded-[2rem] border border-white/5">
                            <span class="text-[10px] font-black text-slate-600 uppercase mb-2 block tracking-widest">PnL Net</span>
                            <div class="text-2xl font-black ${stats.netProfit >= 0 ? 'text-emerald-500' : 'text-rose-500'} italic tracking-tighter">$${stats.netProfit.toLocaleString()}</div>
                        </div>
                        <div class="glass p-6 rounded-[2rem] border border-white/5">
                            <span class="text-[10px] font-black text-slate-600 uppercase mb-2 block tracking-widest">Total Snipes</span>
                            <div class="text-2xl font-black text-white italic tracking-tighter">${stats.totalTrades}</div>
                        </div>
                        <div class="glass p-6 rounded-[2rem] border border-white/5">
                            <span class="text-[10px] font-black text-slate-600 uppercase mb-2 block tracking-widest">Profit Factor</span>
                            <div class="text-2xl font-black text-amber-500 italic tracking-tighter">${stats.profitFactor}</div>
                        </div>
                    </div>

                    <div class="glass p-8 rounded-[3rem] border border-white/5 shadow-2xl">
                        <h2 class="text-xl font-black text-white flex items-center gap-3 uppercase italic mb-8 border-b border-white/5 pb-6">
                            <i data-lucide="history" class="text-amber-500"></i> Historique Cloud
                        </h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left min-w-[700px]">
                                <thead class="text-[10px] text-slate-500 font-black uppercase tracking-widest border-b border-white/5">
                                    <tr>
                                        <th class="pb-6 w-12 text-center">Detail</th>
                                        <th class="pb-6">Date</th>
                                        <th class="pb-6 text-center">Score</th>
                                        <th class="pb-6 text-center">Capture</th>
                                        <th class="pb-6 text-right">PnL ($)</th>
                                        <th class="pb-6 text-right pr-4">Action</th>
                                    </tr>
                                </thead>
                                <tbody class="text-xs">
                                    ${state.tradeLogs.length === 0 ? '<tr><td colspan="6" class="py-20 text-center text-slate-700 font-black uppercase tracking-[0.4em]">Aucun sniping enregistré</td></tr>' : ''}
                                    ${state.tradeLogs.map(t => `
                                        <tr class="border-b border-white/5 hover:bg-white/5 transition-all">
                                            <td class="py-5 text-center">
                                                <button onclick="toggleExpand('${t.id}')" class="p-2 text-slate-600 hover:text-white transition-colors">
                                                    <i data-lucide="${state.expandedTrade === t.id ? 'chevron-up' : 'chevron-down'}" class="w-4 h-4"></i>
                                                </button>
                                            </td>
                                            <td class="py-5 font-mono text-slate-400 font-bold">${t.timestamp ? new Date(t.timestamp.seconds * 1000).toLocaleDateString() : 'Sync...'}</td>
                                            <td class="py-5 text-center font-black text-amber-500 italic">${t.checklistStatus}/6</td>
                                            <td class="py-5 text-center">
                                                ${t.screenshotData ? `<img src="${t.screenshotData}" class="w-10 h-10 object-cover rounded-xl border border-white/10 shadow-lg mx-auto" />` : '<span class="opacity-10">-</span>'}
                                            </td>
                                            <td class="py-5 text-right font-black italic tracking-tighter ${Number(t.pnl) >= 0 ? 'text-emerald-500' : 'text-rose-500'}">$${Number(t.pnl).toLocaleString()}</td>
                                            <td class="py-5 text-right pr-2">
                                                <button onclick="deleteTrade('${t.id}')" class="p-2 text-slate-800 hover:text-rose-500 transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                            </td>
                                        </tr>
                                        ${state.expandedTrade === t.id ? `
                                            <tr class="bg-black/40 border-b border-white/5 animate-fadeIn">
                                                <td colspan="6" class="p-8">
                                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                                                        <div class="space-y-6">
                                                            <div>
                                                                <h4 class="text-[10px] font-black text-amber-500 uppercase italic mb-3 tracking-widest">Analyse Psychologique</h4>
                                                                <p class="text-xs text-slate-300 italic leading-relaxed bg-white/5 p-5 rounded-2xl border border-white/5 whitespace-pre-wrap">${t.emotions || "Pas de notes enregistrées."}</p>
                                                            </div>
                                                            <div class="flex items-center gap-4 text-[10px] font-black uppercase text-slate-500">
                                                                <span>TYPE: <span class="${t.type === 'BUY' ? 'text-emerald-500' : 'text-rose-500'}">${t.type || 'N/A'}</span></span>
                                                                <span class="w-1.5 h-1.5 rounded-full bg-slate-800"></span>
                                                                <span>SCORE PLAN: ${t.checklistStatus || 0}/6</span>
                                                            </div>
                                                        </div>
                                                        ${t.screenshotData ? `
                                                            <div class="space-y-3">
                                                                <h4 class="text-[10px] font-black text-slate-500 uppercase italic tracking-widest text-center md:text-left">Capture Graphique</h4>
                                                                <div class="rounded-2xl overflow-hidden border border-white/10 shadow-2xl group relative cursor-zoom-in">
                                                                    <img src="${t.screenshotData}" class="w-full h-auto" />
                                                                </div>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </td>
                                            </tr>
                                        ` : ''}
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- DÉMARRAGE ---
        start();
    </script>
</body>
</html>
